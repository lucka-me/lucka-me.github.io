<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Megrim:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />



  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.0.4">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Tech,Programming," />


<meta name="description" content="随着作为某大赛参赛作品提交，巡检应用 Patroute 的制作终于暂告一段落了。 紧接着又开了一个新坑，名为 RoundO 的所谓「城市定向越野」应用。虽然组长称其为定向越野，我个人觉得其实和 Patroute 一样本质上都是「LBS 打卡应用」，所以一开始直接套用了 Patroute 的代码框架进行开发。不过在开发过程中还是一点一点地做了不少修改，到现在已经完成了当初设想的大部分功能，代码和 P">
<meta name="keywords" content="Tech,Programming">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 开发笔记">
<meta property="og:url" content="https://lucka.moe/2018/08/27/android-dev-note/index.html">
<meta property="og:site_name" content="Lucka">
<meta property="og:description" content="随着作为某大赛参赛作品提交，巡检应用 Patroute 的制作终于暂告一段落了。 紧接着又开了一个新坑，名为 RoundO 的所谓「城市定向越野」应用。虽然组长称其为定向越野，我个人觉得其实和 Patroute 一样本质上都是「LBS 打卡应用」，所以一开始直接套用了 Patroute 的代码框架进行开发。不过在开发过程中还是一点一点地做了不少修改，到现在已经完成了当初设想的大部分功能，代码和 P">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-08-27T08:14:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 开发笔记">
<meta name="twitter:description" content="随着作为某大赛参赛作品提交，巡检应用 Patroute 的制作终于暂告一段落了。 紧接着又开了一个新坑，名为 RoundO 的所谓「城市定向越野」应用。虽然组长称其为定向越野，我个人觉得其实和 Patroute 一样本质上都是「LBS 打卡应用」，所以一开始直接套用了 Patroute 的代码框架进行开发。不过在开发过程中还是一点一点地做了不少修改，到现在已经完成了当初设想的大部分功能，代码和 P">



  <link rel="alternate" href="/atom.xml" title="Lucka" type="application/atom+xml" />




  <link rel="canonical" href="https://lucka.moe/2018/08/27/android-dev-note/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Android 开发笔记 | Lucka</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lucka</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-info-circle"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://lucka.moe/2018/08/27/android-dev-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://s.gravatar.com/avatar/f03d18971cd558e09f51ad19923bf077?s=256">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lucka">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android 开发笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T16:14:56+08:00">2018-08-27</time>
            

            
            
              
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/27/android-dev-note/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/27/android-dev-note/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>随着作为某大赛参赛作品提交，<a href="https://github.com/lucka-me/Patroute-android" title="lucka-me/Patroute-android | GitHub" target="_blank" rel="noopener">巡检应用 Patroute</a> 的制作终于暂告一段落了。</p>
<p>紧接着又开了一个新坑，名为 <a href="https://github.com/lucka-me/RoundO-android" title="lucka-me/RoundO-android | GitHub" target="_blank" rel="noopener">RoundO</a> 的所谓「城市定向越野」应用。虽然组长称其为定向越野，我个人觉得其实和 Patroute 一样本质上都是「LBS 打卡应用」，所以一开始直接套用了 Patroute 的代码框架进行开发。<br>不过在开发过程中还是一点一点地做了不少修改，到现在已经完成了当初设想的大部分功能，代码和 Patroute 的有了很大的差异。结果现在再看 Patroute 的代码会有种「完蛋了这种东西绝对会被评委乱棍打到死无音讯」的感觉……</p>
<p>在这里以 RoundO 为例子，把开发过程中学到的东西和解决的问题记一记。</p>
<a id="more"></a>
<h2 id="Activity-生命周期"><a href="#Activity-生命周期" class="headerlink" title="Activity 生命周期"></a>Activity 生命周期</h2><p>在 Android 开发中， Activity 的生命周期是一个基础概念，很多应用需要应对前后台切换、保存/加载关键数据，这些都必须在正确的生命周期节点（所对应的回调）中完成。个人觉得比较关键的有 <code>onCreate()</code>、<code>onPause()</code> 和 <code>onResume()</code> 这三个节点。</p>
<p><code>onCreate()</code> 是整个生命周期的开始，数据会从这里开始一直保持到 Activity 被销毁，所以在这里除了要完成定义和初始化各个成员、为 UI 组件添加监听器等工作之外，还应该加载关键数据并恢复状态（比如任务数据和状态）。</p>
<p><code>onPause()</code> 和 <code>onResume()</code> 两个节点之间是 Activity 真正在最顶层活动的时期，是「安全」的。一旦 <code>onPause()</code> 被调用，就意味着 Activity 不再在最顶层活动，也不再「安全」，应用可能不经 <code>onDestroy()</code> 就被结束，因此必须在此处保存关键数据（调用 <code>MissionManager.pause()</code>），并暂停任务和定位、计时等监听，不过可以转入服务的形式以继续运行。</p>
<p><code>onResume()</code> 则是应用从后台回到顶层时，或者从 <code>onCreate()</code> 开始时<strong>都会</strong>经历的节点，在初期我天真地认为应该从这恢复任务（调用 <code>MissionManager.resume()</code>）和监听，但其实这样简单的处理存在很大问题：在 RoundO 中，从开始任务界面 <code>SetupActivity</code> 点击确认之后会返回 <code>MainAtivity</code> 并从 <code>onActivityResult()</code> 处开始任务：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span> (requestCode) &#123;</span><br><span class="line"></span><br><span class="line">    AppRequest.ActivitySetup.code -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (resultCode == Activity.RESULT_OK) &#123;</span><br><span class="line">            <span class="comment">// Something else here</span></span><br><span class="line">            missionManager.start(locationKit.lastLocation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果导致它与之后才调用的 <code>onResume()</code> 的恢复任务相冲突，后者加载的数据覆盖了开始任务所生成的数据，结果任务无法开始。<br>后来找到了解决方法，就是视情况加载数据，当调用 <code>MissionManager.pause()</code> 时会将属性 <code>state</code> 修改为 <code>Pause</code>，然后在 <code>onResume()</code> 中，仅当任务处在这一状态时才恢复数据：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (missionManager.state == MissionManager.MissionState.Paused) &#123;</span><br><span class="line">        missionManager.resume()</span><br><span class="line">    &#125;</span><br><span class="line">    locationKit.startUpdate()</span><br><span class="line">    <span class="keyword">super</span>.onResume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外这样的话在 <code>onCreate()</code> 中恢复数据之后也不会在 <code>onResume()</code> 中再次恢复数据导致混乱。</p>
<h2 id="「面向对象编程」和-MainActivity-的作用"><a href="#「面向对象编程」和-MainActivity-的作用" class="headerlink" title="「面向对象编程」和 MainActivity 的作用"></a>「面向对象编程」和 MainActivity 的作用</h2><p>面向对象编程在我看来就是将原本放在一起的变量和函数分门别类，用「类」封装起来，或者将原本通用型的系统接口再次封装等等。总的来说目的都是隐藏细节、令代码更精简、有条理，便于后续开发。比如 Patroute 和 RoundO 中，我将与任务有关的部分封装进 <code>MissionManager</code> 里，它的代码行数甚至比 <code>MainActivity</code> 还多；在 RoundO 中我还进一步将定位相关部分封装进 <code>LocationKit</code>，将地图控制相关部分封装进 <code>MapKit</code>，将显示对话框的功能封装进 <code>DialogKit</code>，大大简化了 <code>MainActivity</code> 的代码。</p>
<p>我认为 <code>MainAtivity</code> 是起到一个调度中枢的作用，接收回调并调用各个成员的方法，而具体的工作由各个成员完成。</p>
<p>在这一点上 Patroute 没做好，<code>MainAtivity</code> 里还留了很多本该被封装的代码，例如位置更新后检索检查点列表、显示普通警告对话框等等。RoundO 其实也有一些残留（主要是仪表盘对话框），希望后续能继续封装，保持 <code>MainAtivity</code> 「调度员」的身份。<br><del>啊没想到边写这篇文章边改就改完然后 Commit 上去了（</del></p>
<h2 id="首选项检查和重置"><a href="#首选项检查和重置" class="headerlink" title="首选项检查和重置"></a>首选项检查和重置</h2><p>RoundO 在生成任务前要让用户对参数进行设置，比如任务范围、签到点数量等，我很自然地想到利用首选项（<code>Preference</code>）来完成这个功能。不过其中有个要求是必须对用户输入的值进行合法性判断，最理想的方法自然是在用户输入时直接检查、提示和重置，但要实现这个效果似乎必须自己写新的 <code>Preference</code> 类。<br>我不太确定自己能否成功，于是选择在用户输入新值之后在回调中进行判断、提示以及重置<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSharedPreferenceChanged</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    sharedPreferences: <span class="type">SharedPreferences</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: <span class="type">String</span>?</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sharedPreferences == <span class="literal">null</span> || key == <span class="literal">null</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">when</span> (key) &#123;</span><br><span class="line"></span><br><span class="line">        getString(R.string.setup_basic_radius_key) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (sharedPreferences.getString(</span><br><span class="line">                    key, getString(R.string.setup_basic_radius_default)</span><br><span class="line">                ).toDouble() &lt; <span class="number">0.1</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                resetValue(key, getString(R.string.setup_basic_radius_default))</span><br><span class="line">                warnIllegalValue(R.string.setup_basic_radius_warning)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">resetValue</span><span class="params">(key: <span class="type">String</span>, <span class="keyword">default</span>: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    defaultSharedPreferences.edit().putString(key, <span class="keyword">default</span>).apply()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但 <code>resetValue()</code> 里的代码似乎不会立即刷新首选项的显示，即 <code>SharedPreferences</code> 中值已经重置，但界面，包括 <code>EditTextPreference</code> 对话框里依然显示原来的值，必须退出这个 Activity 再进入才能看到新值。</p>
<p>对此，根据 <a href="https://stackoverflow.com/a/31671831" title="How do you refresh PreferenceActivity to show changes in the settings? | Stack Overflow" target="_blank" rel="noopener">Stack Overflow 的答案</a>，需要重新载入首选项资源：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">resetValue</span><span class="params">(key: <span class="type">String</span>, <span class="keyword">default</span>: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    defaultSharedPreferences.edit().putString(key, <span class="keyword">default</span>).apply()</span><br><span class="line">    preferenceScreen.removeAll()</span><br><span class="line">    addPreferencesFromResource(R.xml.preference_setup)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样在重设之后界面会闪（刷新）一下，不算完美，但<del>偷懒</del>目的达成。</p>
<h2 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h2><p>在实际使用中，Android 应用处在前台的时间其实非常少，一个 Activity 通过 <code>onPaused()</code> 进入后台其实是非常频繁的，除了回到桌面、切到其它应用，甚至打开应用内的 Activity（比如首选项界面）、锁屏都会进入后台。为了让用户更加自由，就要在进入后台时启动服务，继续定位和进行任务。</p>
<p>服务有后台、前台和绑定三种服务，RoundO 使用的是前台服务，即通过 <code>startService()</code> 或 <code>startForegroundService()</code> 配合 <code>startForeground()</code> 启动的服务（<a href="https://developer.android.com/guide/components/services?hl=zh-cn" title="服务 | Android Developers" target="_blank" rel="noopener">Android Developers 的中文页面</a>还是按照旧分类描述的，没有更新，是个坑……），它可以尽量保证服务不被结束，不过需要提供一条持续通知来令服务对用户可见。</p>
<p>由于之前没经验，在前台服务上就栽了好几个跟头。</p>
<p>首先要确定的是，因为线程的关系，正常情况下当应用本身结束的时候服务也会随之结束，<strong>而且此时服务的 <code>onDestroy()</code> 并不一定会被调用</strong>，按我的是研究过来看是「几乎不会被调用」……所以如果要在服务中进行任务，就必须定时保存数据，虽然听上去很没效率，但对于不熟悉多线程的我来说这能解决不少问题：在 <code>onResume()</code> 中，我这样处理服务和任务：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (missionManager.state == MissionManager.MissionState.Paused) &#123;</span><br><span class="line">        <span class="comment">// Stop the background service</span></span><br><span class="line">        <span class="keyword">val</span> backgroundMissionService =</span><br><span class="line">            Intent(<span class="keyword">this</span>, BackgroundMissionService::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">        stopService(backgroundMissionService)</span><br><span class="line"></span><br><span class="line">        missionManager.resume()</span><br><span class="line">    &#125;</span><br><span class="line">    locationKit.startUpdate()</span><br><span class="line">    <span class="keyword">super</span>.onResume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里 <code>stopService()</code> 是可以引发服务内 <code>onDestroy()</code> 回调的，但服务使用的似乎并不是主线程，如果不做多线程处理，<code>missionManager.resume()</code> 会先一步执行，因此在服务的 <code>onDestroy()</code> 中存储数据是行不通的。</p>
<p>其次，前台服务要求提供一条通知，而通知必须设置三个要素：标题（<code>setContentTitle()</code>）、内容（<code>setContentText()</code> 或 <code>setContent()</code>）和小图标（<code>setSmallIcon()</code>），<a href="https://www.jianshu.com/p/5792cf3090bc" title="自定义 Notification 样式遇到的坑 | 简书" target="_blank" rel="noopener">缺一不可</a>。</p>
<p>再次是对 Android O 的适配。我用来测试的两台手机分别是魅族 MX4 Pro（Flyme 6.3，Android 5.1.1）和华为 G7 Plus（EMUI 4，Android 6.0.1），模拟器最近大概是<del>喝醉了</del>哪里坏掉了，装不上应用。后来借到了同学的小米 6（MIUI，Android 8.0.0）测试了一小会，发现 Android O 宛如天坑。首先，启动前台服务必须在 <code>MainActivity</code> 里就换用 <code>startForegroundService()</code>，这个不是问题，问题是 Android O 要求先建立 <code>NotificationChannel</code> 创建一个通过 ID 识别的通知频道，再调用 <code>startForeground()</code> 才能正常显示通知……<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">    <span class="keyword">val</span> notificationChannel =</span><br><span class="line">        NotificationChannel(</span><br><span class="line">            CHANNEL_ID,</span><br><span class="line">            getString(R.string.app_name),</span><br><span class="line">            NotificationManager.IMPORTANCE_DEFAULT</span><br><span class="line">        )</span><br><span class="line">    notificationChannel.description =</span><br><span class="line">        getString(R.string.service_notification_channel_description)</span><br><span class="line">    notificationManager?.createNotificationChannel(notificationChannel)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>官方指南里根本没写啊……还是我没看见……啊反正最后还是 <a href="https://stackoverflow.com/a/44705829" title="Android foreground service notification not showing | Stack Overflow" target="_blank" rel="noopener">Stack Overflow</a> 把我从苦海中拯救出来的……</p>
<p>然后关于后台进程保活的问题，终于遇到了，<del>传说中</del>各种国产 ROM 的坑！<br>最开始意识到这个问题是在华为上测试的时候，每次锁屏系统都会把服务杀掉，根本不留情面，代码怎么写都没用，隔壁魅族就一直好好的，后来摸索了大半天发现 EMUI 的手机管家里有个「受保护应用」，介绍里赫然写着「锁屏后清理后台应用」……</p>
<blockquote class="blockquote-center"><p>哇<br>绝了<br>无话可说</p>
<p><div style="font-size:32px;">RoundO</div></p>
<p><div style="font-size:64px;">保护</div><br>行了</p>
</blockquote>
<p>于是为了引导用户开启这个选项，我在首选项界面里加了一个「后台限制」的说明选项，为此特意去查了如何<a href="https://blog.csdn.net/yu75567218/article/details/78109686" title="Android获取操作系统名称 | CSDN" target="_blank" rel="noopener">检测 ROM 类型</a>以及<a href="https://www.jianshu.com/p/797e23f10266" title="Android 设置默认桌面,默认应用,辅助功能,电池优化,设备管理器,悬浮窗等 | 简书" target="_blank" rel="noopener">打开后台设置</a>，然后又发现 Android O 因为缩紧文件权限所以<a href="https://blog.csdn.net/zwww_/article/details/80340335" title="Android O更改状态栏颜色出现 /system/build.prop (Permission denied) | CSDN" target="_blank" rel="noopener">又不一样</a>……</p>
<p>最后就这样：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getType</span><span class="params">()</span></span>: RomType &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) &#123;</span><br><span class="line">        <span class="keyword">val</span> buildProp = Properties()</span><br><span class="line">        buildProp.load(FileInputStream(File(Environment.getRootDirectory(), <span class="string">"build.prop"</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">            buildProp.containsKey(EMUI_KEY) -&gt; RomType.EMUI</span><br><span class="line">            buildProp.containsKey(MIUI_KEY) -&gt; RomType.MIUI</span><br><span class="line">            Build.DISPLAY.toUpperCase().contains(FLYME_KEYWORD) -&gt; RomType.FLYME</span><br><span class="line">            <span class="keyword">else</span> -&gt; RomType.OTHER</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressLint(<span class="meta-string">"PrivateApi"</span>)</span></span><br><span class="line">            <span class="keyword">val</span> clazz = Class.forName(SYSTEM_PROP_CLASS)</span><br><span class="line">            <span class="keyword">val</span> methodGet =</span><br><span class="line">                clazz.getMethod(<span class="string">"get"</span>, String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">String::class.java)</span></span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">                (methodGet.invoke(clazz, EMUI_KEY, <span class="string">""</span>) <span class="keyword">as</span> String) != <span class="string">""</span> -&gt; RomType.EMUI</span><br><span class="line">                (methodGet.invoke(clazz, MIUI_KEY, <span class="string">""</span>) <span class="keyword">as</span> String) != <span class="string">""</span> -&gt; RomType.MIUI</span><br><span class="line">                Build.DISPLAY.toUpperCase().contains(FLYME_KEYWORD) -&gt; RomType.FLYME</span><br><span class="line">                <span class="keyword">else</span> -&gt; RomType.OTHER</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error: Exception) &#123;</span><br><span class="line">            <span class="keyword">return</span> RomType.OTHER</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>居然用了私有 API…感到良心不安（啥</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>因为个人的陋习，我并没有系统性地学习过 Android 开发，整个开发过程都是「面向 Google 和 Stack Overflow 编程」，也就是「写什么查什么」，因此很多概念都是在这个过程中慢慢理解的，还存在很多不足，对原理的理解也可以说几乎等于零。在写这篇文章的过程中也体会到了：很多东西不知道如何转换成文字来表述，只能用看上去很业余又很莫名其妙的词汇去形容。</p>
<p>经过 Patroute 和 RoundO 的开发，也（再一次）认识到了自己的短板：算法一无所知，数据库一点不会，网络一窍不通，多线程是啥……这应该不是长久之计吧，而且真正的、能糊口等级的应用开发又是什么样子的呢，站在人生岔路口的自己竟然对此一无所知，慌啊。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Tech/" rel="tag"># Tech</a>
          
            <a href="/tags/Programming/" rel="tag"># Programming</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/23/wallmapper/" rel="next" title="Wallmapper">
                <i class="fa fa-chevron-left"></i> Wallmapper
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://s.gravatar.com/avatar/f03d18971cd558e09f51ad19923bf077?s=256"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/lucka_me" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://github.com/lucka-me" target="_blank" title="GitHub"><i class="fa fa-fw fa-github-alt"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://steamcommunity.com/id/lucka_me/" target="_blank" title="Steam"><i class="fa fa-fw fa-steam"></i>Steam</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://bangumi.tv/user/309731" target="_blank" title="Bangumi"><i class="fa fa-fw fa-star"></i>Bangumi</a>
                  
                </span>
              
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity-生命周期"><span class="nav-number">1.</span> <span class="nav-text">Activity 生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#「面向对象编程」和-MainActivity-的作用"><span class="nav-number">2.</span> <span class="nav-text">「面向对象编程」和 MainActivity 的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#首选项检查和重置"><span class="nav-number">3.</span> <span class="nav-text">首选项检查和重置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前台服务"><span class="nav-number">4.</span> <span class="nav-text">前台服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">5.</span> <span class="nav-text">后记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lucka</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.4</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  

  
    <script id="dsq-count-scr" src="https://luckablog.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://lucka.moe/2018/08/27/android-dev-note/';
        this.page.identifier = '2018/08/27/android-dev-note/';
        this.page.title = 'Android 开发笔记';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://luckablog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  
















  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
